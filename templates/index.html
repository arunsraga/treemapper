<!DOCTYPE html>
<html>
<head>
	<title>Treemapper.in</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="IE=Edge">
	<link rel="stylesheet" href="css/bootstrap.min.css" />
	<link rel="stylesheet" href="css/font-awesome.min.css" />
	<link rel="stylesheet" href="css/nprogress.css" />
	<link rel="stylesheet" href="css/treemapper.css" />
</head>
<body>
	{% include "includes/navbar.html" %}
	<div class="message-overlay">
		<div class="content">
			<i class="icon-refresh icon-spin icon-lg text-muted"></i><br>
			Starting Treemapper...
		</div>
	</div>
	<div class="container">
		<div class="splash row" style="display: none">
			<div style="height: 400px; background: url(img/sander-zelhem-green-passage.jpg) center; 
				color: white; margin-top: -40px; width: 100%;">
				<h1 style="color: white; padding: 30px;">Map Trees in your Neighbourhood</h1>
				<button class="btn btn-default btn-lg btn-login" 
					style="margin: 30px; margin-top: 0px;">Get Started Now</button>
			</div>
		</div>
		<div class="add-tree" style="display: none;">
			<h2>Add A Tree</h2>
			<hr>
			<!-- step 1 -->
			<div class="step-1">
				<h3>1 of 5: Select Type</h3>
				<br>
				<div class="row">
					<div class="col-xs-12">
						<select class="form-control tree-type-select">
							<option value="select">Select Tree Type...</option>
							{% for n in local_names -%}
							<option value="{{ n }}">{{ n }}</option>
							{%- endfor %}
						</select>
						<br>
					</div>
				</div>
				<div class="alert alert-warning type-not-selected">Select a tree type first.</div>
				<div class="alert alert-info tree-details" style="display: none;">
					<a href="#" target="_blank">View this tree on Tree Guide</a>
				</div>
				<button class="btn btn-primary btn-lg pull-right 
					btn-step-1" disabled="disabled" data-next="2">Next: Add Pictures</button>
			</div>
			<!-- step 2 -->
			<div class="step-2" style="display: none;">
				<h3>2 of 5: Add Tree Picture</h3>
				<br>
				<div class="alert alert-warning">1. Stand a few feet away from the tree 
					and take an image covering as much of the tree as you can and as little 
					of anything else as you can.</div>
				<div style="position: relative;">
					<button class="btn btn-primary btn-lg">
						<i class="icon-camera"></i> Attach Tree Image</button>
					<input class="form-control tree-img-input" data-name="tree_img"
						data-ok-img="icon-tree-ok" data-next="3"
						style="opacity: 0; position: absolute; top: 0; 
							z-index: 1; cursor: pointer; height: 45px; width: 208px;"
						type="file" name="tree-photo">
					<i class="icon-ok" id="icon-tree-ok" style="display:none"></i>
				</div>
			</div>
			<!-- step 3 -->
			<div class="step-3" style="display: none;">
				<h3>3 of 5: Add Leaf Picture</h3>
				<br>
				<div class="alert alert-warning">2. Optionally, take an image of the leaf 
					on a clean background.
				</div>
				<div style="position: relative;">
					<button class="btn btn-primary btn-lg">
						<i class="icon-camera"></i> Attach Leaf Image</button>
					<input class="form-control tree-leaf-input" data-name="leaf_img"
						data-ok-img="icon-leaf-ok" data-next="4"
						style="opacity: 0; position: absolute; top: 0; 
							z-index: 1; cursor: pointer; height: 45px; width: 208px;"
						type="file" name="leaf-photo">
					
					<i class="icon-ok" id="icon-leaf-ok" style="display:none"></i>
				</div>
				<br><br>
				<button class="btn btn-default pull-right
					btn-step-2" data-next="4">Skip This Step</button>
			</div>
			<!-- step 4 -->
			<div class="step-4" style="display: none;">
				<h3>4 of 5. Capture Location</h3>
				<br>
				<div class="alert alert-warning">Stand As Close to the tree as possible 
					and click on the button below. Make sure your GPS is activated.</div>
				<br>
				<div class="text-center">
					<button class="btn btn-danger btn-lg btn-location"><i class="icon-map-marker"></i> Capture Location Now</button>
					<i class="icon-ok" id="icon-location-ok" style="display:none"></i>
				</div>
				<br>
			</div>
			<!-- step 5 -->
			<div class="step-5" style="display: none;">
				<h3>5 of 5. Additional Details</h3>
				<br>
				<div class="alert alert-warning">Add as many details as you can.</div>
				<br>
				<div class="row">
					<div class="col-xs-12">
						<textarea class="form-control details" rows=5 placeholder="Additional Info"></textarea>
					</div>
				</div>
				<br>
				<br>
				<div class="row">
					<div class="col-xs-12">
						<button class="btn btn-success btn-lg pull-right
							btn-save"><i class="icon-save"></i> Save</button>
					</div>
				</div>
			</div>
			<div class="step-6" style="display: none;">
				<div class="alert alert-success">Congrats! Your tree was successfully added.
					<a href="javascript:location.reload()">Refresh to add another tree!</a>
				</div>
			</div>
		</div>
	</div>
	{% include "includes/footer.html" %}
	<script src="js/jquery.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/nprogress.js"></script>
	<script src="js/treemapper.js"></script>
	<script src="https://login.persona.org/include.js"></script>
	<script>
		tree_info = {}
		treemapper.current_step = "1";
		$(".btn[data-next]").on("click", function() {
			treemapper.show_step($(this).attr("data-next"));
		});
	
		// step-1
		$(".tree-type-select").on("change", function() {
			var val = $(this).val();
			if(val==="select") {
				$(".type-not-selected").toggle(true);
				$(".tree-details").toggle(false);
				$(".btn-step-1").attr("disabled", "disabled");
			} else {
				$(".type-not-selected").toggle(false);
				$(".btn-step-1").attr("disabled", false);
				$(".tree-details").toggle(true).find("a")
					.attr("href", val.replace(/ /g, "_").toLowerCase() + ".html");
			}
		})
				
		// step-2
		$(".tree-img-input, .tree-leaf-input").change(function() {
			if (this.type === 'file' && this.files && this.files.length > 0) {
				var me = this;
				$.each(this.files, function (idx, fileobj) {
					if (/^image\//.test(fileobj.type)) {
						var freader = new FileReader();
						freader.onload = function() {
							// show ok sign
							$("#" + $(me).attr("data-ok-img")).toggle(true);
							
							// save file data in tree_info
							tree_info[$(me).attr("data-name")] = freader.result.split(",")[1];
							
							// go-next
							treemapper.show_step($(me).attr("data-next"))
						};
						freader.readAsDataURL(fileobj);
					}
				});
			}
		});
				
		// step-4
		$(".btn-location").on("click", function() {
			NProgress.start();
			try {
				treemapper.show_message("Getting Location...", "icon-map-marker");
				navigator.geolocation.getCurrentPosition(function(pos) {
					if(pos) {
						tree_info.latitude = pos.coords.latitude;
						tree_info.longitude = pos.coords.longitude;
						$("#icon-location-ok").toggle(true);
						treemapper.show_step("5");
					} else {
						alert("Please activate GPS in your device to capture location.")
					}
					NProgress.done();
					treemapper.hide_message();
				})
			} catch(e) {
				NProgress.done();
				treemapper.hide_message();
				alert("Please activate GPS in your device and allow the browser to use your location.")
			}
		});
				
		$(".btn-save").on("click", function() { 
			treemapper.show_message("Saving your tree...")
			$(this).attr("disabled", "disabled");
			tree_info.local_name = $(".tree-type-select").val();
			tree_info.details = $(".details").val();
			treemapper.call("save", tree_info, function(r) {
				if(r.status==="okay") {
					treemapper.hide_message();
					treemapper.show_step("6");
				} else {
					treemapper.show_message("There were errors!", "icon-error");
				}
				$(".btn").attr("disabled", false);
			})
		});
	</script>
</body>
</html>
